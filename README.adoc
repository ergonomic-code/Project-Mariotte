:toc: macro
:toc-levels: 3
:toc-title: Содержение
ifdef::env-github[]
:note-caption: :information_source:
endif::[]

= Project Mariotte

Проект Мариотт - это демо проект https://azhidkov.pro/ergo-approach/landing/[Эргономичного подхода] на примере сервиса бронирования номеров в отелях.

toc::[]

== Карта проекта

. Код иллюстрирующий Эргономичный подход
.. Тестирование
... Тесты на поведение
... Эффективный запуск реального PostgreSQL
... Доменно-спецефичный матчер
... Генерация случайных тестовых данных
... ObjectMothers
... RepeatedTest
.. Неизменяемая модель данных
.. Структурный дизайн
.. Модель на базе диаграммы эффектов
... Простая операция
... Сложная операция
... Простой ресурс
... Сложный ресурс
.. Кодирование
... Обход проблемы интеграции Spring Transactions с Kotlin Result
... "Очевидизация" вариантов ответов эндпоинта

. Прочие "Points of interest"
.. Верификация Json-схем
.. Problem Details
... ErrorResponse
... UnhandledExceptionsHandler
.. PostgreSQL generate_series
.. Пессимистичные блокировки в Spring Data JDBC
.. Kotlin value-класс
.. Реестр Json-схем

== "Техническое задание"

* Сервис должен обеспечивать бронирования номеров в разных отелях;
* Сервис должен поддерживать типы номероров, определённых международным стандартом ISO 404:404 - люкс и полулюкс;
* Бронировние определяет только тип номера, но не конкрентный номер.
Конкретный номер выбирает администратор при заселении гостя;
* Сервис должен исключать овербукинг - создание большего количества броней номеров определённого типа в одном отеле за определённую дату, чем есть в целом номеров данного типа в отеле;
* Сервис должен недопускать бронирования, начинающиеся ранее следующих суток относительно момента времени запроса на бронирование.

== Системная аналитика

=== Модель предметной области

image::docs/images/ER.drawio.svg[]

[NOTE]
====
Модель предметной области представлена https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/[Эргономичной нотации ER-модели]
====

=== Спецификация HTTP API

[NOTE]
====
Этот раздела написан в моём самодельном легковесном и слабоформализованном формате описания HTTP-эндпоинтов.

Маппинг ошибок на коды статусов выполнен в соответствии с https://github.com/ergonomic-code/Ergo-Approach-Guideline/wiki/Проектирование-HTTP-API#коды-ошибок[гайдлайном эргономичного подхода].
====

==== Модель RoomReservationRequest

[source]
----
{
  "hotelId": <number>
  "roomType": <number>
  "email": <string:email>
  "from": <string:iso-8601 date>
  "period": <string:iso-8601 duration>
}
----

==== Модель ReservationSuccess

[source]
----
{
  "reservationId": <number>
}
----

==== Модель ReservationDetails

[source]
----
{
  "hotel": <number>
  "roomType": <number>
  "email": <string:email>
  "from": <string:iso-8601 date>
  "period": <string:iso-8601 duration>
}
----

==== Модель ErrorResponse

Соответсвтует спецификации https://datatracker.ietf.org/doc/html/rfc7807[Problem Details for HTTP APIs], всегда содержит дополнительное свойство timestamp.

[source]
----
{
  "timestamp": <string:iso-8601 timestmap>,
  "instance": <string:uri-reference>,
  "status": <number:200..600>,
  "type": <string:uri-reference>
  "title": <string>
  "details": <string>
}
----

==== Метод reserveRoom

Метод бронирования комнаты в отеле на период.

Предусловия:

* Передан идентификатор отеля, существующий в БД;
* Передан корректный тип номера;
* В заданном отеле есть номера заданного типа;
* Переданная дата "от" находится в будущем, не менее чем на один день от момента поступления запроса;
* Длительность периода составляет один или более дней;
* В запрошенном отеле за каждый запрошенный день есть свободный номер запрошенного типа.

Постусловия:

* В БД в коллекцию бронирований добавлен добавлена бронь, соответсвующая запросу;
* Количество досутпных номеров указанного типа за указанный период уменьшено на 1.

[source]
----
POST /guest/reservations
>
  <RoomReservationRequest>

<
  201
    <ReservationSuccess>

  400
    <ErrorResponse> // некорректный зарос

  409
    <ErrorResponse:reservation-dates-in-past> // до даты начала резервации осталось менее дня

  409
    <ErrorResponse:hotel-not-found> // отель с указанным идентификатором не найден

  409
    <ErrorResponse:room-type-not-found> // номер указанного типа в отеле с указанным идентификатором не найден

  409
    <ErrorResponse:no-available-rooms> // за запрошенные даты в отеле нет свободных комнат запрошенного типа

  500
    <ErrorResponse> // при обработке запроса произошла ошибка неожиданная ошибка
----

==== Метод getReservationDetails

Метод просмотра информации о бронировании

Предусловия:

* Передан идентификатор существующей брони;

Постусловия:

* Возвращена информация о бронировании, соответсвующая переданному идентификатору

[source]
----
GET /guest/reservations/{reservationId}
>

<
  201
    <ReservationDetails>

  400
    <ErrorResponse> // некорректный зарос

  500
    <ErrorResponse> // при обработке запроса произошла ошибка неожиданная ошибка
----

=== Диаграмма эффектов

image::docs/images/arch.drawio.svg[]

Здесь используется обновлённая и пока неописанная нотацяия https://azhidkov.pro/effects-diagram/landing/[Диаграамы эффектов] - зелёные шестиугольники это события, филетовые прямугольнии и круги - операции, оранжевые (коричневые?) прямугольники - ресурсы, ресурсы в ресурсах - агрегированные ресурсы.

=== Структурная схема (Граф вызовов)

image::docs/images/Call-graph.drawio.svg[]

Здесь красными блоками отмечены функции с эффектами (функции, выполняющие ввод-вывод - императивная оболочка), а синими - чистые функции трансформаций (функциональное ядро).

=== Структура пакетов

.Пакеты приложения со стержневыми классами и зависимостями между ними
image::docs/images/packages.png[]

.Опивание пакетов приложения
|===
|Пакет |Описание

|mariotte
|Код, специфичный для данного приложения.

|mariotte.apps
|Код приложений проекта.

Я придерживаюсь модели, когда у одного проекта может быть несколько приложений исходя из ролей пользователей и UX.

Как правило у проекта есть приложения анонима для входа в систему, приложения основного пользователя для работы с системой, приложение администратора для настройки системы, приложение DevOps-инженера/инфраструктуры для эксплуатации
и технического обслуживания системы.

В этом проекте есть только приложение гостя - основного пользователя системы.

|mariotte.apps.guest
|Код обеспечивающий работу приложения гостя.

|mariotte.apps.guest.reservations
|Код обеспечивающий работу юз-кейса "Бронирование номера".

пакеты отдельных приложений можно декомпозировать по экранам пользовательского интерфейса, юз-кейсам и фичам,
в зависимости от ваших предпочетний.

|mariote.apps.infra
|Пакет инфраструктурных бинов все (web-) приложений.

В любом пакете приложения может быть подпакет infra, который содержит определения инфраструктурых Spring-бинов,
обеспечивающих работу модуля родительского пакета.

В данном случае в этом пакете содержится бин, глобального обработчика ошибок, который рендерит ошибки в
виде ProblemDetails с timestamp-ом.

|mariotte.apps.platform
|Библиотечный код, используемый всеми приложениями.

Эвристика для разделения инфраструктурного кода - количество и срок жизни экземпляров классов.
Если экземпляров создаётся не много и живут они долго - такие штуки идут в infra.
Если это статические (top-level) функции или объекты которые создаются в больших количествах и живут миллисекунды - такой код идёт в platform.

|mariotte.apps.platform.spring
|Библиотечный код, дополняющий проекты Spring.

У меня нет жёсткого гайдлайна по декомпозиции кода платформы, но в целом я стараюсь чтобы структура пакетов напоминала струкутру пакетов, дополняемеого кода.

|mariotte.apps.platform.spring.http
|Расширения классов в пакете `org.springframework.http`

|mariotte.core
|Ядро (предметная область, сущности, ресурсы) системы.

Части ядра используются разными приложениями.

Например, часть приложения с профилями пользователей может использоваться как приложением основого ползователя для доступа к собственному профилю, так и приложением администратора для доступа к профилю любого пользователя.

`core` содержит ресурсы, управляемые разработчиками проекта, а ресурсы, управляемые третьими лицами, помещаются в пакет `i9ns` (integrations).

|mariotte.core.hotels
a|Пакет составного ресурса логического^*^ агрегата "Отель".

[NOTE]
====
^*^ см. https://azhidkov.pro/microposts/23/11/immutable-relation-data-model-v2/[Нотация описания неизменяемой модели данных].
====

|mariotte.core.hotels.rooms
|Пакет ресурса физического агрегата "Номер".

|mariotte.core.hotels.root
|Пакет ресурса физического агрегата "Отель", который является корнем одноимённого логического агрегата.

|mariotte.core.reservations
|Пакет ресурса агрегата "Бронь".

|mariotte.core.infra
|Пакет с инфраструктурными бинами (конвертерами класса Period в данном случае), обеспечивающими работу модулей ядра.

|platform
|Универсальный код, который можно переиспользовать во множесте приложений.
Как вариант, его можно вынести в отдельную библиотеку, но на мой взгляд это создаст лишнюю сцепленность
между независимыми проектами, поэтому я обычно такой код копирую по мере необходимости.

|platform.domain.errors
|Фреймворк доменных ошибок, используемый всем прикладным кодом.

|platform.kotlin
|Расширения стандартной библиотеки Kotlin.

|platform.java.lang
|Расширения классов из пакета `java.lang`

|platform.postgres
|Расширения классов JDBC-драйвера PostgreSQL.

|platform.spring
|Расширения модулей Spring

|platfrom.spring.jdbc
|Расширения классов из пакета `org.springframework.jdbc`

|platfrom.spring.data
|Дополнения функциональности модуля Spring Data Commons

|===

== Требования к окружению

== Запуск тестов

== Сборка проекта

== Запуск проекта

=== Примеры запросов